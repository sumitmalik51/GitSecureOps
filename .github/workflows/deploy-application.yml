name: Deploy Application to Azure Static Web Apps

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - staging
        - prod

env:
  NODE_VERSION: '20.x'

jobs:
  deploy-application:
    runs-on: ubuntu-latest
    
    steps:
    - name: 'Checkout GitHub Action'
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Deploy Frontend to Static Web Apps
      run: |
        set -e  # Exit on any error
        RESOURCE_GROUP="rg-gitsecureops-${{ inputs.environment }}"
        SWA_NAME=$(az staticwebapp list --resource-group $RESOURCE_GROUP --query "[0].name" -o tsv)
        SWA_URL=$(az staticwebapp list --resource-group $RESOURCE_GROUP --query "[0].defaultHostname" -o tsv)
        FUNCTION_APP_NAME="func-gh-${{ inputs.environment }}"
        
        # Validate resources exist
        if [ -z "$SWA_NAME" ]; then
          echo "‚ùå Error: Static Web App not found in resource group $RESOURCE_GROUP"
          exit 1
        fi
        
        if [ -z "$SWA_URL" ]; then
          echo "‚ùå Error: Could not retrieve Static Web App URL"
          exit 1
        fi
        
        echo "üîß Building frontend with environment variables..."
        echo "  - Static Web App: https://$SWA_URL"
        echo "  - Function App: https://$FUNCTION_APP_NAME.azurewebsites.net"
        echo "  - OAuth Client ID: ${{ secrets.GH_WEB_APP }}"
        
        # Install frontend dependencies and build
        npm ci
        # Build with all necessary environment variables
        VITE_GITHUB_CLIENT_ID=${{ secrets.GH_WEB_APP }} \
        VITE_FUNCTION_APP_URL=https://$FUNCTION_APP_NAME.azurewebsites.net \
        VITE_STATIC_WEB_APP_URL=https://$SWA_URL \
        VITE_GITHUB_REDIRECT_URI=https://$FUNCTION_APP_NAME.azurewebsites.net/api/github-callback \
        npm run build
        
        # Validate build output
        if [ ! -d "dist" ] || [ -z "$(ls -A dist)" ]; then
          echo "‚ùå Error: Build failed - dist directory is missing or empty"
          exit 1
        fi
        
        # Install SWA CLI
        npm install -g @azure/static-web-apps-cli
        
        # Deploy frontend only to Static Web Apps (API stays on Function App)
        SWA_TOKEN=$(az staticwebapp secrets list --resource-group $RESOURCE_GROUP --name $SWA_NAME --query "properties.apiKey" -o tsv)
        
        if [ -z "$SWA_TOKEN" ]; then
          echo "‚ùå Error: Could not retrieve Static Web Apps deployment token"
          exit 1
        fi
        
        echo "üöÄ Deploying frontend to Static Web Apps production environment..."
        swa deploy ./dist --deployment-token "$SWA_TOKEN" --env production --verbose
        
        echo "‚úÖ Frontend deployed successfully!"
        echo "üåê Frontend URL: https://$SWA_URL"
        echo "üîó OAuth Callback URL: https://$FUNCTION_APP_NAME.azurewebsites.net/api/github-callback"

    - name: Deploy Function App
      run: |
        set -e  # Exit on any error
        RESOURCE_GROUP="rg-gitsecureops-${{ inputs.environment }}"
        FUNCTION_APP_NAME="func-gh-${{ inputs.environment }}"
        
        echo "üîß Preparing Function App deployment..."
        echo "  - Resource Group: $RESOURCE_GROUP"
        echo "  - Function App: $FUNCTION_APP_NAME"
        
        # Validate Function App exists
        FUNCTION_EXISTS=$(az functionapp show --resource-group $RESOURCE_GROUP --name $FUNCTION_APP_NAME --query "name" -o tsv 2>/dev/null || echo "")
        if [ -z "$FUNCTION_EXISTS" ]; then
          echo "‚ùå Error: Function App $FUNCTION_APP_NAME not found in resource group $RESOURCE_GROUP"
          exit 1
        fi
        
        # Install Function App dependencies
        cd api
        echo "üì¶ Installing Function App dependencies..."
        if [ -f "package-lock.json" ]; then
          npm ci
        else
          npm install
        fi
        
        # Validate api structure
        if [ ! -f "host.json" ]; then
          echo "‚ùå Error: host.json not found in api directory"
          exit 1
        fi
        
        if [ ! -d "github-callback" ]; then
          echo "‚ùå Error: github-callback function not found"
          exit 1
        fi
        
        # Install Azure Functions Core Tools
        echo "üõ†Ô∏è Installing Azure Functions Core Tools..."
        npm install -g azure-functions-core-tools@4 --unsafe-perm true
        
        # Deploy Function App
        echo "üöÄ Deploying Function App: $FUNCTION_APP_NAME"
        func azure functionapp publish $FUNCTION_APP_NAME --javascript --build-native-deps
        
        echo "‚úÖ Function App deployed successfully!"
        echo "üîó Function App URL: https://$FUNCTION_APP_NAME.azurewebsites.net"
        cd ..

    - name: Update Function App Settings for OAuth
      run: |
        RESOURCE_GROUP="rg-gitsecureops-${{ inputs.environment }}"
        FUNCTION_APP_NAME="func-gh-${{ inputs.environment }}"
        SWA_URL=$(az staticwebapp list --resource-group $RESOURCE_GROUP --query "[0].defaultHostname" -o tsv)
        
        if [ -n "$SWA_URL" ]; then
          echo "Updating Function App FRONTEND_URL setting to: https://$SWA_URL"
          az functionapp config appsettings set \
            --resource-group "$RESOURCE_GROUP" \
            --name "$FUNCTION_APP_NAME" \
            --settings "FRONTEND_URL=https://$SWA_URL" \
            --output table
          echo "‚úÖ Function App FRONTEND_URL updated for OAuth redirect fix"
        else
          echo "‚ö†Ô∏è Warning: Could not retrieve Static Web App URL"
        fi

    - name: Azure logout
      run: |
        az logout
      if: always()
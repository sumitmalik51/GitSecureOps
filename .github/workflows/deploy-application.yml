name: Deploy GitSecureOps Application

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - staging
        - prod

env:
  NODE_VERSION: '20.x'

jobs:
  deploy-application:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    # Set environment-specific secrets
    - name: Set environment-specific variables
      id: set-env
      run: |
        if [ "${{ inputs.environment }}" == "dev" ]; then
          echo "GH_CLIENT_ID=${{ secrets.GH_WEB_APP_DEV }}" >> $GITHUB_ENV
          echo "GH_CLIENT_SECRET=${{ secrets.GH_WEB_APP_SECRET_DEV }}" >> $GITHUB_ENV
        else
          echo "GH_CLIENT_ID=${{ secrets.GH_WEB_APP }}" >> $GITHUB_ENV
          echo "GH_CLIENT_SECRET=${{ secrets.GH_WEB_APP_SECRET }}" >> $GITHUB_ENV
        fi

    - name: Deploy Frontend to Static Web Apps
      run: |
        set -e
        RESOURCE_GROUP="rg-gitsecureops-${{ inputs.environment }}"
        SWA_NAME=$(az staticwebapp list --resource-group $RESOURCE_GROUP --query "[0].name" -o tsv)
        SWA_URL=$(az staticwebapp list --resource-group $RESOURCE_GROUP --query "[0].defaultHostname" -o tsv)
        FUNCTION_APP_NAME="func-gh-${{ inputs.environment }}"

        # Validate resources
        if [ -z "$SWA_NAME" ]; then
          echo "‚ùå Static Web App not found in resource group $RESOURCE_GROUP"
          exit 1
        fi
        if [ -z "$SWA_URL" ]; then
          echo "‚ùå Could not retrieve Static Web App URL"
          exit 1
        fi

        echo "üîß Building frontend..."
        npm ci
        VITE_GITHUB_CLIENT_ID=$GH_CLIENT_ID \
        VITE_FUNCTION_APP_URL=https://$FUNCTION_APP_NAME.azurewebsites.net \
        VITE_STATIC_WEB_APP_URL=https://$SWA_URL \
        npm run build

        npm install -g @azure/static-web-apps-cli
        SWA_TOKEN=$(az staticwebapp secrets list --resource-group $RESOURCE_GROUP --name $SWA_NAME --query "properties.apiKey" -o tsv)

        swa deploy ./dist --deployment-token "$SWA_TOKEN" --env ${{ inputs.environment }} --verbose

        echo "‚úÖ Frontend deployed: https://$SWA_URL"
        echo "üîó OAuth callback: https://$FUNCTION_APP_NAME.azurewebsites.net/api/github-callback"

    - name: Deploy Function App
      run: |
        set -e
        RESOURCE_GROUP="rg-gitsecureops-${{ inputs.environment }}"
        FUNCTION_APP_NAME="func-gh-${{ inputs.environment }}"

        echo "üîß Deploying Function App: $FUNCTION_APP_NAME"

        # Validate API structure
        cd api
        if [ ! -f "host.json" ]; then
          echo "‚ùå host.json not found in api folder"
          exit 1
        fi
        if [ ! -d "github-callback" ]; then
          echo "‚ùå github-callback function not found"
          exit 1
        fi

        npm install -g azure-functions-core-tools@4 --unsafe-perm true
        func azure functionapp publish $FUNCTION_APP_NAME --build-remote
        echo "‚úÖ Function App deployed: https://$FUNCTION_APP_NAME.azurewebsites.net"

    - name: Update Function App settings for OAuth
      run: |
        RESOURCE_GROUP="rg-gitsecureops-${{ inputs.environment }}"
        FUNCTION_APP_NAME="func-gh-${{ inputs.environment }}"
        SWA_URL=$(az staticwebapp list --resource-group $RESOURCE_GROUP --query "[0].defaultHostname" -o tsv)

        echo "üîß Updating Function App OAuth settings..."
        az functionapp config appsettings set \
          --resource-group "$RESOURCE_GROUP" \
          --name "$FUNCTION_APP_NAME" \
          --settings \
            "GH_WEB_APP=$GH_CLIENT_ID" \
            "GH_WEB_APP_SECRET=$GH_CLIENT_SECRET" \
            "FRONTEND_URL=https://$SWA_URL" \
          --output table

        echo "‚úÖ Function App settings updated"

    - name: Azure logout
      run: |
        az logout
      if: always()

name: Deploy Application to Azure Static Web Apps

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - staging
        - prod

env:
  NODE_VERSION: '20.x'

jobs:
  deploy-application:
    runs-on: ubuntu-latest
    
    steps:
    - name: 'Checkout GitHub Action'
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Deploy Frontend to Static Web Apps
      run: |
        RESOURCE_GROUP="rg-gitsecureops-${{ inputs.environment }}"
        SWA_NAME=$(az staticwebapp list --resource-group $RESOURCE_GROUP --query "[0].name" -o tsv)
        SWA_URL=$(az staticwebapp list --resource-group $RESOURCE_GROUP --query "[0].defaultHostname" -o tsv)
        
        # Install frontend dependencies and build
        npm ci
        VITE_GITHUB_CLIENT_ID=${{ secrets.GH_WEB_APP }} VITE_GITHUB_REDIRECT_URI=https://$SWA_URL/api/github-callback npm run build
        
        # Install SWA CLI
        npm install -g @azure/static-web-apps-cli
        
        # Deploy both frontend and API to Static Web Apps (API functions will be handled by SWA built-in functionality)
        SWA_TOKEN=$(az staticwebapp secrets list --resource-group $RESOURCE_GROUP --name $SWA_NAME --query "properties.apiKey" -o tsv)
        echo "Deploying frontend and API to Static Web Apps production environment..."
        echo "Frontend: ./dist"
        echo "API: ./api"
        swa deploy ./dist --api-location ./api --deployment-token "$SWA_TOKEN" --env production --verbose
        
        echo "✅ Frontend and API deployed: https://$SWA_URL"

    - name: Configure Static Web App Environment Variables
      run: |
        RESOURCE_GROUP="rg-gitsecureops-${{ inputs.environment }}"
        SWA_NAME=$(az staticwebapp list --resource-group $RESOURCE_GROUP --query "[0].name" -o tsv)
        SWA_URL=$(az staticwebapp list --resource-group $RESOURCE_GROUP --query "[0].defaultHostname" -o tsv)
        
        # Set environment variables for the API functions
        echo "Configuring environment variables for API functions..."
        az staticwebapp appsettings set \
          --resource-group "$RESOURCE_GROUP" \
          --name "$SWA_NAME" \
          --setting-names "GH_WEB_APP=${{ secrets.GH_WEB_APP }}" \
          --setting-names "GH_WEB_APP_SECRET=${{ secrets.GH_WEB_APP_SECRET }}" \
          --setting-names "FRONTEND_URL=https://$SWA_URL" \
          --output table
        
        echo "✅ Environment variables configured for API functions"

    - name: Azure logout
      run: |
        az logout
      if: always()
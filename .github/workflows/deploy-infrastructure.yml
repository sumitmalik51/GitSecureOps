name: Deploy Infrastructure to Azure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - staging
        - prod
      region:
        description: 'Azure region'
        required: true
        default: 'eastus'
        type: string

env:
  NODE_VERSION: '20.x'

jobs:
  deploy-infrastructure:
    runs-on: windows-latest
    
    steps:
    - name: 'Checkout GitHub Action'
      uses: actions/checkout@v4

    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Upgrade Azure CLI and Bicep
      run: |
        Write-Host "Upgrading Azure CLI and Bicep..."
        az --version
        az bicep upgrade
        az bicep version
        Write-Host "Upgrade completed!"

    - name: Deploy Infrastructure
      run: |
        $RESOURCE_GROUP = "rg-gitsecureops-${{ inputs.environment }}"
        $DEPLOYMENT_NAME = "infra-deployment-$(Get-Date -Format 'yyyyMMdd-HHmmss')"
        
        # Deploy with explicit name and error handling
        Write-Host "Deploying infrastructure with name: $DEPLOYMENT_NAME"
        try {
          az deployment sub create `
            --name "$DEPLOYMENT_NAME" `
            --location ${{ inputs.region }} `
            --template-file infra/main.bicep `
            --parameters `
              environmentName=${{ inputs.environment }} `
              location=${{ inputs.region }} `
              resourceGroupName="$RESOURCE_GROUP" `
              githubClientId='${{ secrets.GH_WEB_APP }}' `
              githubRedirectUri='https://placeholder.azurestaticapps.net/oauth-callback' `
              githubClientSecret='${{ secrets.GH_WEB_APP_SECRET }}' `
            --no-wait
          
          Write-Host "Deployment submitted. Waiting for completion..."
          az deployment sub wait --name "$DEPLOYMENT_NAME" --created
          
          Write-Host "Getting deployment outputs..."
          $SWA_URL = az deployment sub show `
            --name "$DEPLOYMENT_NAME" `
            --query 'properties.outputs.STATICWEBAPP_URL.value' `
            -o tsv
          
          Write-Host "‚úÖ App deployed: https://$SWA_URL"
          Write-Host "üìã OAuth Redirect URI: https://$SWA_URL/oauth-callback"
        }
        catch {
          Write-Host "‚ùå Deployment failed: $_"
          exit 1
        }

    - name: Azure logout
      run: az logout
      if: always()